services:

  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    hostname: plex
    restart: unless-stopped
    network_mode: host
    depends_on:
      - zurg
      - rclone
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=latest
    devices:
      - /dev/dri:/dev/dri
    volumes:
      - /mnt/Docker/Apps/Plex/config:/config
      - /mnt/Abyss/Media:/media
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  plexautolanguages:
    image: ghcr.io/journeydocker/plex-auto-languages:main
    container_name: plexautolanguages
    hostname: plexautolanguages
    restart: unless-stopped
    networks:
      - bunni_network
    depends_on:
      - plex
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /mnt/Docker/Apps/PlexAutoLanguages:/config
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

  plexanisync:
    image: ghcr.io/rickdb/tautulli-plexanisync:master
    container_name: tautulli-plexanisync
    hostname: tautulli-plexanisync
    restart: unless-stopped
    networks:
      - bunni_network
    depends_on:
      - plex
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - PLEX_SECTION=${PLEX_SECTION}
      - PLEX_URL=${PLEX_URL}
      - PLEX_TOKEN=${PLEX_TOKEN}
      - ANI_USERNAME=${ANI_USERNAME}
      - ANI_TOKEN=${ANI_TOKEN}
      - PLEX_EPISODE_COUNT_PRIORITY=${PLEX_EPISODE_COUNT_PRIORITY}
      - SKIP_LIST_UPDATE=${SKIP_LIST_UPDATE}
      - LOG_FAILED_MATCHES=${LOG_FAILED_MATCHES}
      - INTERVAL=${INTERVAL}
    volumes:
      - /mnt/Docker/Apps/PlexAniSync/custom_mappings.yaml:/plexanisync/custom_mappings.yaml
      - /mnt/Docker/Apps/PlexAniSync/failed_matches.txt:/plexanisync/failed_matches.txt
      - /mnt/Docker/Apps/Tautulli:/config
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - 20042:8181/tcp

  plextraktsync:
    image: ghcr.io/taxel/plextraktsync:latest
    container_name: plextraktsync
    hostname: plextraktsync
    restart: on-failure:2
    networks:
      - bunni_network
    depends_on:
      - plex
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /mnt/Docker/Apps/PlexTraktSync:/app/config
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    command: ["watch"]

  zurg:
    image: ghcr.io/debridmediamanager/zurg:latest
    container_name: zurg
    hostname: zurg
    restart: unless-stopped
    networks:
      - bunni_network
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /mnt/Docker/Apps/Zurg/config.yml:/app/config.yml
      - /mnt/Docker/Apps/Zurg/data:/app/data
      - /mnt/Docker/Apps/Zurg/dump:/app/dump
      - /mnt/Docker/Apps/Zurg/logs:/app/logs
      - /mnt/Docker/Apps/Zurg/trash:/app/trash
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    ports:
      - 9999:9999
    healthcheck:
      test: ["CMD-SHELL", "curl -fSs http://localhost:9999/dav/version.txt || exit 1"]
      interval: 30s
      retries: 3
      start_period: 30s
      timeout: 10s
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  rclone:
    image: docker.io/rclone/rclone:latest
    container_name: rclone
    hostname: rclone
    restart: unless-stopped
    networks:
      - bunni_network
    cap_add:
      - SYS_ADMIN
    depends_on:
      - zurg
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    devices:
      - /dev/fuse:/dev/fuse:rwm
    volumes:
      - /mnt/Zurg:/data:rshared
      - /mnt/Docker/Apps/Zurg/rclone.conf:/config/rclone/rclone.conf
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    security_opt:
      - apparmor:unconfined
    command: "mount zurg: /data --allow-other --allow-non-empty --attr-timeout 10y --buffer-size 128M --dir-cache-time 10s --poll-interval 60s --vfs-cache-max-age 2M --vfs-cache-max-size 50G --vfs-cache-min-free-space 2G --vfs-cache-mode full --vfs-cache-poll-interval 30s --vfs-disk-space-total-size 100G --vfs-fast-fingerprint --vfs-read-ahead 64M --vfs-read-chunk-size 1M --vfs-read-chunk-size-limit 32M --vfs-read-wait 40ms --vfs-refresh --transfers 32 --checkers 32 --multi-thread-streams 8 --fast-list --no-console"
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

networks:
  bunni_network:
    external: true
